<!DOCTYPE html>
<!--
    Basically Basic Jekyll Theme 1.3.1
    Copyright 2017-2018 Michael Rose - mademistakes.com | @mmistakes
    Free for personal and commercial use under the MIT license
    https://github.com/mmistakes/jekyll-basically-theme/blob/master/LICENSE.md
-->
<html lang="en-US" class="no-js">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    <title>Musings of a Software Development Manager</title>
    <meta name="description" content="lessons learned managing developers">
    <link rel="canonical" href="https://edgibbs.com/page2/">
  

  <script>
    /* Cut the mustard */
    if ( 'querySelector' in document && 'addEventListener' in window ) {
      document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + 'js';
    }
  </script>

  <link rel="stylesheet" href="/assets/stylesheets/main.css">
  

  
    
    <link rel="alternate" type="application/atom+xml" title="Musings of a Software Development Manager" href="/feed.xml">
  
</head>


  <body class="layout--home ">

    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#primary-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>


    <div class="sidebar-toggle-wrapper">
      

      <button class="toggle navicon-button larr" type="button">
        <span class="toggle-inner">
          <span class="sidebar-toggle-label visually-hidden">Menu</span>
          <span class="navicon"></span>
        </span>
      </button>
    </div>

    <div id="sidebar" class="sidebar">
      <div class="inner">
        <nav id="primary-nav" class="site-nav" itemscope itemtype="http://schema.org/SiteNavigationElement" aria-label="Main navigation">
  <ul id="menu-main-navigation" class="menu">
    <!-- Home link -->
    <li class="menu-item">
      <a href="/" itemprop="url">
        <span itemprop="name">Home</span>
      </a>
    </li>

    <!-- site.pages links -->
    
    

    
      
      
    
      
      
        <li class="menu-item">
          <a href="/archive.html" itemprop="url">
            <span itemprop="name">Archive</span>
          </a>
        </li>
      
    
      
      
        <li class="menu-item">
          <a href="/bio.html" itemprop="url">
            <span itemprop="name">Bio</span>
          </a>
        </li>
      
    
      
      
    
      
      
        <li class="menu-item">
          <a href="/junit-4-with-hamcrest.html" itemprop="url">
            <span itemprop="name">JUnit 4 with Hamcrest</span>
          </a>
        </li>
      
    
      
      
        <li class="menu-item">
          <a href="/spock-intro-a-bdd-testing-framework-in-groovy.html" itemprop="url">
            <span itemprop="name">Spock Intro</span>
          </a>
        </li>
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
      
      
    
  </ul>
</nav>

        <ul class="contact-list">
  
    <li>
      <a href="mailto:ed@edgibbs.com">
        <span class="icon icon--email"><svg xmlns="http://www.w3.org/2000/svg" viewBox="313.1 3.7 16 16"><path d="M318.5 8.9c0-.2.2-.4.4-.4h4.5c.2 0 .4.2.4.4s-.2.4-.4.4h-4.5c-.3 0-.4-.2-.4-.4zm.4 2.1h4.5c.2 0 .4-.2.4-.4s-.2-.4-.4-.4h-4.5c-.2 0-.4.2-.4.4s.1.4.4.4zm3.5 1.2c0-.2-.2-.4-.4-.4h-3.1c-.2 0-.4.2-.4.4s.2.4.4.4h3.1c.2.1.4-.1.4-.4zm-1.5-8.4l-1.7 1.4c-.2.1-.2.4 0 .6s.4.2.6 0l1.4-1.2 1.4 1.2c.2.1.4.1.6 0s.1-.4 0-.6l-1.7-1.4c-.3-.1-.5-.1-.6 0zm7.8 6.2c.1.1.1.2.1.3v7.9c0 .8-.7 1.5-1.5 1.5h-12.5c-.8 0-1.5-.7-1.5-1.5v-7.9c0-.1.1-.2.1-.3l1.6-1.3c.2-.1.4-.1.6 0s.1.4 0 .6l-1.2 1 1.8 1.3v-4c0-.6.5-1.1 1.1-1.1h7.5c.6 0 1.1.5 1.1 1.1v4l1.8-1.3-1.2-1c-.2-.1-.2-.4 0-.6s.4-.2.6 0l1.6 1.3zm-11.6 2.2l4 2.8 4-2.8V7.6c0-.1-.1-.2-.2-.2h-7.5c-.1 0-.2.1-.2.2v4.6zm10.9-1l-4.7 3.4 3.4 2.6c.2.1.2.4.1.6-.1.2-.4.2-.6.1l-3.6-2.8-1.2.8c-.1.1-.3.1-.5 0l-1.2-.8-3.6 2.8c-.2.1-.4.1-.6-.1-.1-.2-.1-.4.1-.6l3.4-2.6-4.7-3.4v7.1c0 .4.3.6.6.6h12.5c.4 0 .6-.3.6-.6v-7.1z"/></svg></span>
        <span class="label">Email</span>
      </a>
    </li>
  

  
    <li><a href="https://github.com/edgibbs">
  <span class="icon icon--github"><svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M8 0C3.58 0 0 3.582 0 8c0 3.535 2.292 6.533 5.47 7.59.4.075.547-.172.547-.385 0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.725-.496.056-.486.056-.486.803.056 1.225.824 1.225.824.714 1.223 1.873.87 2.33.665.072-.517.278-.87.507-1.07-1.777-.2-3.644-.888-3.644-3.953 0-.873.31-1.587.823-2.147-.09-.202-.36-1.015.07-2.117 0 0 .67-.215 2.2.82.64-.178 1.32-.266 2-.27.68.004 1.36.092 2 .27 1.52-1.035 2.19-.82 2.19-.82.43 1.102.16 1.915.08 2.117.51.56.82 1.274.82 2.147 0 3.073-1.87 3.75-3.65 3.947.28.24.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.14.46.55.38C13.71 14.53 16 11.53 16 8c0-4.418-3.582-8-8-8"/></svg></span>
  <span class="label">GitHub</span>
</a>
</li>
  

  
    <li><a href="https://www.linkedin.com/in/edwardgibbs">
  <span class="icon icon--linkedin"><svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51v1.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z" fill-rule="nonzero"/></svg></span>
  <span class="label">LinkedIn</span>
</a>
</li>
  

  
    <li><a href="https://ruby.social/@edgibbs">
  <img src="/images/icon-mastodon.svg" alt="Mastodon" height=24 width=24 />
  <span class="label">Mastodon</span>
</a>
</li>
  

  
    <li><a href="https://twitter.com/edward_gibbs">
  <span class="icon icon--twitter"><svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M16 3.038c-.59.26-1.22.437-1.885.517.677-.407 1.198-1.05 1.443-1.816-.634.37-1.337.64-2.085.79-.598-.64-1.45-1.04-2.396-1.04-1.812 0-3.282 1.47-3.282 3.28 0 .26.03.51.085.75-2.728-.13-5.147-1.44-6.766-3.42C.83 2.58.67 3.14.67 3.75c0 1.14.58 2.143 1.46 2.732-.538-.017-1.045-.165-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.22-.276.074-.566.114-.865.114-.21 0-.41-.02-.61-.058.42 1.304 1.63 2.253 3.07 2.28-1.12.88-2.54 1.404-4.07 1.404-.26 0-.52-.015-.78-.045 1.46.93 3.18 1.474 5.04 1.474 6.04 0 9.34-5 9.34-9.33 0-.14 0-.28-.01-.42.64-.46 1.2-1.04 1.64-1.7z" fill-rule="nonzero"/></svg></span>
  <span class="label">Twitter</span>
</a>
</li>
  

  <li>
    
      <a href="/feed.xml" title="Atom Feed">
        <span class="icon icon--rss"><svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd" stroke-linejoin="round" stroke-miterlimit="1.414"><path d="M12.8 16C12.8 8.978 7.022 3.2 0 3.2V0c8.777 0 16 7.223 16 16h-3.2zM2.194 11.61c1.21 0 2.195.985 2.195 2.196 0 1.21-.99 2.194-2.2 2.194C.98 16 0 15.017 0 13.806c0-1.21.983-2.195 2.194-2.195zM10.606 16h-3.11c0-4.113-3.383-7.497-7.496-7.497v-3.11c5.818 0 10.606 4.79 10.606 10.607z"/></svg></span>
        <span class="label">Subscribe</span>
      </a>
    
  </li>
</ul>

      </div>
    </div>

    <div class="canvas">
      <div class="wrapper">
        

<header id="masthead">
  <div class="inner">
    <div class="title-area">
      
        <p class="site-title">
          <a href="/">
            <img src="/images/avatar.jpg" alt="" class="site-logo">
            <span>Musings of a Software Development Manager</span>
          </a>
        </p>
      
    </div>
  </div>
</header>

        <div class="initial-content">
          


<main id="main" class="page-content" aria-label="Content">
  <div class="index inner">
    <div></div>

    <div>
      <div class="entries">
        
          
          
  

<article class="entry">
  <header class="entry-header">
    <h3 class="entry-title">
      <a href="/2020/07/11/rspec-instance-double-with-class-names/" rel="bookmark">RSpec Instance Double With Class Names
</a>
    </h3>
  </header>
  <footer class="entry-meta">
    <ul>
    
      <li><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="379 72 16 16"><g><g><path fill="none" d="M380.8,86.7h12.3v-8.8h-12.3V86.7z M389.5,78.8h1.7v1.4h-1.7V78.8z M389.5,81.3h1.7v1.4h-1.7V81.3z M389.5,83.8h1.7v1.4h-1.7V83.8z M386.1,78.8h1.7v1.4h-1.7V78.8z M386.1,81.3h1.7v1.4h-1.7V81.3z M386.1,83.8h1.7v1.4h-1.7V83.8z M382.8,78.8h1.7v1.4h-1.7V78.8z M382.8,81.3h1.7v1.4h-1.7V81.3z M382.8,83.8h1.7v1.4h-1.7V83.8z"/><polygon fill="none" points="384.7 75.1 383.4 75.1 383.4 74.3 380.8 74.3 380.8 76.6 393.2 76.6 393.2 74.3 390.6 74.3 390.6 75.1 389.3 75.1 389.3 74.3 384.7 74.3"/><rect x="382.8" y="78.8" width="1.7" height="1.4"/><rect x="386.1" y="78.8" width="1.7" height="1.4"/><rect x="389.5" y="78.8" width="1.7" height="1.4"/><rect x="382.8" y="81.3" width="1.7" height="1.4"/><rect x="386.1" y="81.3" width="1.7" height="1.4"/><rect x="389.5" y="81.3" width="1.7" height="1.4"/><rect x="382.8" y="83.8" width="1.7" height="1.4"/><rect x="386.1" y="83.8" width="1.7" height="1.4"/><rect x="389.5" y="83.8" width="1.7" height="1.4"/><path d="M383.4,72v1.1h-3.8V88h14.9V73.1h-3.8V72h-1.3v1.1h-4.7V72H383.4z M393.2,86.7h-12.3v-8.8h12.3L393.2,86.7L393.2,86.7z M389.3,74.3v0.8h1.3v-0.8h2.5v2.3h-12.3v-2.3h2.5v0.8h1.3v-0.8H389.3z"/></g></g></svg></span><time class="entry-time" datetime="2020-09-13T00:00:00+00:00">September 13, 2020</time></li>
    
    
    </ul>
  </footer>
  <div class="entry-excerpt">
      <p>After many years working with RSpec I discovered a nice little feature and a small gotcha with instance doubles.
I’ve used <code class="language-plaintext highlighter-rouge">instance_double</code> since before it was ported from <a href="https://github.com/xaviershay/rspec-fire">rspec-fire</a>.</p>

<p>My practice and all the current Relish RSpec examples of <code class="language-plaintext highlighter-rouge">instance_double</code> use the following format:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">let</span><span class="p">(</span><span class="ss">:public_policy</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance_double</span><span class="p">(</span><span class="s1">'Users::PublicPolicy'</span><span class="p">)</span> <span class="p">}</span></code></pre></figure>

<p>It turns out the actual <code class="language-plaintext highlighter-rouge">instance_double()</code> method takes a string representing the class or just the class constant:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">instance_double</span><span class="p">(</span><span class="n">doubled_class</span><span class="p">)</span></code></pre></figure>

<p>And the important part here is the parameter:</p>

<p><code class="language-plaintext highlighter-rouge">doubled_class(String, Class)</code></p>

<p>No String is required here and class constants are auto-verifying. According to a long discussion
on <a href="https://github.com/rspec/rspec-mocks/issues/842">rspec-mocks</a> this behavior exists to avoid some
auto-loading of classes that aren’t needed so that tests can be a bit faster in some cases. For me this breaks
the expectation that I the mock is actually verifying that the class and methods actually exist. If I
wanted just a pure mock I could just use <code class="language-plaintext highlighter-rouge">double</code>.  And for Rails projects that make up a lot of the day to day
paid developer work everything auto-loads anyway. Using class constants is just simpler. If you’re on a legacy
project you can probably just add the config to verify the strings ahead of time anyway with the following:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">config</span><span class="p">.</span><span class="nf">mock_with</span> <span class="ss">:rspec</span> <span class="k">do</span> <span class="o">|</span><span class="n">mocks</span><span class="o">|</span>
  <span class="n">mocks</span><span class="p">.</span><span class="nf">verify_doubled_constant_names</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span></code></pre></figure>

<p>This example code shows what happens when you make a typo in the string constant name and you don’t have the config to verify set:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td><td class="code"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>
<span class="nb">require_relative</span> <span class="s1">'../../lib/users/policy_enforcer'</span>
<span class="nb">require_relative</span> <span class="s1">'../../lib/users/public_policy'</span>

<span class="no">RSpec</span><span class="p">.</span><span class="nf">describe</span> <span class="no">Users</span><span class="o">::</span><span class="no">PolicyEnforcer</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'#allowed?'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:policy_enforcer</span><span class="p">)</span> <span class="p">{</span> <span class="no">Users</span><span class="o">::</span><span class="no">PolicyEnforcer</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">public_policy</span><span class="p">)</span> <span class="p">}</span>

    <span class="n">context</span> <span class="s1">'with correct string instance_double class constant'</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:public_policy</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance_double</span><span class="p">(</span><span class="s1">'Users::PublicPolicy'</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">before</span> <span class="k">do</span>
        <span class="n">allow</span><span class="p">(</span><span class="n">public_policy</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:allowed?</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'returns true'</span> <span class="k">do</span>
        <span class="n">policy_enforcer</span><span class="p">.</span><span class="nf">allowed?</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">public_policy</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_received</span><span class="p">(</span><span class="ss">:allowed?</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'with typo string instance_double class constant'</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:public_policy</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance_double</span><span class="p">(</span><span class="s1">'Use::PublicPolicy'</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">before</span> <span class="k">do</span>
        <span class="n">allow</span><span class="p">(</span><span class="n">public_policy</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:allowed?</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'lies and returns true'</span> <span class="k">do</span>
        <span class="n">policy_enforcer</span><span class="p">.</span><span class="nf">allowed?</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">public_policy</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_received</span><span class="p">(</span><span class="ss">:allowed?</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'with a proper class constant instance_double'</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:public_policy</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance_double</span><span class="p">(</span><span class="no">Users</span><span class="o">::</span><span class="no">PublicPolicy</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">before</span> <span class="k">do</span>
        <span class="n">allow</span><span class="p">(</span><span class="n">public_policy</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:allowed?</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'returns true'</span> <span class="k">do</span>
        <span class="n">policy_enforcer</span><span class="p">.</span><span class="nf">allowed?</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">public_policy</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_received</span><span class="p">(</span><span class="ss">:allowed?</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">'with an typoed class constant instance_double'</span> <span class="k">do</span>
      <span class="n">let</span><span class="p">(</span><span class="ss">:public_policy</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance_double</span><span class="p">(</span><span class="no">User</span><span class="ss">:PublicPolicy</span><span class="p">)</span> <span class="p">}</span>

      <span class="n">before</span> <span class="k">do</span>
        <span class="n">allow</span><span class="p">(</span><span class="n">public_policy</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:allowed?</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s1">'fails because the constant is not defined'</span> <span class="k">do</span>
        <span class="n">policy_enforcer</span><span class="p">.</span><span class="nf">allowed?</span>
        <span class="n">expect</span><span class="p">(</span><span class="n">public_policy</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_received</span><span class="p">(</span><span class="ss">:allowed?</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The result is the spec <code class="language-plaintext highlighter-rouge">with typo string instance double class constant</code> on line 22 lies to you.  It behaves like a plain old double and allows you to accept methods on classes that don’t exist.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">Users::PolicyEnforcer
  <span class="c">#allowed?</span>
    with correct string instance_double class constant
      returns <span class="nb">true
    </span>with typo string instance_double class constant
      lies and returns <span class="nb">true
    </span>with a proper class constant instance_double
      returns <span class="nb">true
    </span>with an typoed class constant instance_double
      fails because the constant is not defined <span class="o">(</span>FAILED - 1<span class="o">)</span>

Failures:

  1<span class="o">)</span> Users::PolicyEnforcer#allowed? with an typoed class constant instance_double fails because the constant isn not defined
     Failure/Error: <span class="nb">let</span><span class="o">(</span>:public_policy<span class="o">)</span> <span class="o">{</span> instance_double<span class="o">(</span>User:PublicPolicy<span class="o">)</span> <span class="o">}</span>

     NameError:
       uninitialized constant PublicPolicy
     <span class="c"># ./spec/users/policy_enforcer_spec.rb:49:in `block (4 levels) in &lt;top (required)&gt;'</span>
     <span class="c"># ./spec/users/policy_enforcer_spec.rb:52:in `block (4 levels) in &lt;top (required)&gt;'</span>

Finished <span class="k">in </span>0.0175 seconds <span class="o">(</span>files took 0.45833 seconds to load<span class="o">)</span>
4 examples, 1 failure

Failed examples:

rspec ./spec/users/policy_enforcer_spec.rb:55 <span class="c"># Users::PolicyEnforcer#allowed? with an typoed class constant instance_double fails because the constant isn not</span>
 defined</code></pre></figure>


  </div>
</article>


  

<article class="entry">
  <header class="entry-header">
    <h3 class="entry-title">
      <a href="/2020/02/9/more-testable-rake-tasks/" rel="bookmark">More Testable Rake Tasks
</a>
    </h3>
  </header>
  <footer class="entry-meta">
    <ul>
    
      <li><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="379 72 16 16"><g><g><path fill="none" d="M380.8,86.7h12.3v-8.8h-12.3V86.7z M389.5,78.8h1.7v1.4h-1.7V78.8z M389.5,81.3h1.7v1.4h-1.7V81.3z M389.5,83.8h1.7v1.4h-1.7V83.8z M386.1,78.8h1.7v1.4h-1.7V78.8z M386.1,81.3h1.7v1.4h-1.7V81.3z M386.1,83.8h1.7v1.4h-1.7V83.8z M382.8,78.8h1.7v1.4h-1.7V78.8z M382.8,81.3h1.7v1.4h-1.7V81.3z M382.8,83.8h1.7v1.4h-1.7V83.8z"/><polygon fill="none" points="384.7 75.1 383.4 75.1 383.4 74.3 380.8 74.3 380.8 76.6 393.2 76.6 393.2 74.3 390.6 74.3 390.6 75.1 389.3 75.1 389.3 74.3 384.7 74.3"/><rect x="382.8" y="78.8" width="1.7" height="1.4"/><rect x="386.1" y="78.8" width="1.7" height="1.4"/><rect x="389.5" y="78.8" width="1.7" height="1.4"/><rect x="382.8" y="81.3" width="1.7" height="1.4"/><rect x="386.1" y="81.3" width="1.7" height="1.4"/><rect x="389.5" y="81.3" width="1.7" height="1.4"/><rect x="382.8" y="83.8" width="1.7" height="1.4"/><rect x="386.1" y="83.8" width="1.7" height="1.4"/><rect x="389.5" y="83.8" width="1.7" height="1.4"/><path d="M383.4,72v1.1h-3.8V88h14.9V73.1h-3.8V72h-1.3v1.1h-4.7V72H383.4z M393.2,86.7h-12.3v-8.8h12.3L393.2,86.7L393.2,86.7z M389.3,74.3v0.8h1.3v-0.8h2.5v2.3h-12.3v-2.3h2.5v0.8h1.3v-0.8H389.3z"/></g></g></svg></span><time class="entry-time" datetime="2020-02-09T00:00:00+00:00">February 9, 2020</time></li>
    
    
    </ul>
  </footer>
  <div class="entry-excerpt">
      <p>A few months ago I had a brief pairing session where I attempted to help another
developer with getting some working tests around a rake task they had created.
They were having issues testing within rake and executing tasks which is a
common issue in rake testing.  My suggesion was to build the entire logic of the
task in a PORO to avoid the pain of testing rake plumbing.</p>

<p>The approach takes the following steps:</p>

<ul>
  <li>Create a spec file to test the new class</li>
  <li>Create a class that handles doing the thing</li>
  <li>Create a spec file for the rake task</li>
  <li>Add the rake task and defer everything to the new class</li>
</ul>

<p>For this example say you have some rake task that should just return the current
versions of ruby and bundler locally.  Not super useful, but it will involve executing
some local commands.  We want to be able to run:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">rake display_versions</span></code></pre></figure>

<p>And have it dump out:</p>

<figure class="highlight"><pre><code class="language-console" data-lang="console"><span class="go">Gathering versions
Ruby VERSION: ruby 2.7.0p0 (2019-12-25 revision 647ee6f091) [x86_64-darwin19]
Bundler VERSION: Bundler version 2.1.4</span></code></pre></figure>

<p>Instead of diving in and just doing all the logic in rake and having to figure out
how to test it in that context, we start with the class that we want to build the
results, say <code class="language-plaintext highlighter-rouge">VersionDisplayer</code>, and we start with the spec:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre><span class="nb">require_relative</span> <span class="s1">'version_displayer'</span>

<span class="n">describe</span> <span class="no">VersionDisplayer</span> <span class="k">do</span>
  <span class="n">describe</span> <span class="s1">'#display'</span> <span class="k">do</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:version_displayer</span><span class="p">)</span> <span class="p">{</span> <span class="no">VersionDisplayer</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
    <span class="n">let</span><span class="p">(</span><span class="ss">:expected_output</span><span class="p">)</span> <span class="k">do</span>
      <span class="o">&lt;&lt;~</span><span class="no">OUTPUT</span><span class="sh">
        Gathering versions
        Ruby VERSION: ruby 2.7.0
        Bundler VERSION: bundler 2.0
</span><span class="no">      OUTPUT</span>
    <span class="k">end</span>

    <span class="n">before</span> <span class="k">do</span>
      <span class="n">allow</span><span class="p">(</span><span class="no">Open3</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:capture2</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="s1">'ruby --version'</span><span class="p">).</span><span class="nf">and_return</span><span class="p">([</span><span class="s1">'ruby 2.7.0'</span><span class="p">,</span> <span class="kp">nil</span><span class="p">])</span>
      <span class="n">allow</span><span class="p">(</span><span class="no">Open3</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:capture2</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="s1">'bundler --version'</span><span class="p">).</span><span class="nf">and_return</span><span class="p">([</span><span class="s1">'bundler 2.0'</span><span class="p">,</span> <span class="kp">nil</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s1">'returns the current bundler and ruby version'</span> <span class="k">do</span>
      <span class="n">expect</span> <span class="p">{</span> <span class="n">version_displayer</span><span class="p">.</span><span class="nf">display</span> <span class="p">}.</span><span class="nf">to</span> <span class="n">output</span><span class="p">(</span><span class="n">expected_output</span><span class="p">).</span><span class="nf">to_stdout</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This leads us to the VersionDisplayer class that satisfies the spec:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="code"><pre><span class="nb">require</span> <span class="s1">'open3'</span>

<span class="k">class</span> <span class="nc">VersionDisplayer</span>
  <span class="k">def</span> <span class="nf">display</span>
    <span class="nb">puts</span> <span class="s2">"Gathering versions"</span>
    <span class="n">ruby_version</span><span class="p">,</span> <span class="n">_status</span> <span class="o">=</span> <span class="no">Open3</span><span class="p">.</span><span class="nf">capture2</span><span class="p">(</span><span class="s1">'ruby --version'</span><span class="p">)</span>
    <span class="n">bundler_version</span><span class="p">,</span> <span class="n">_status</span> <span class="o">=</span> <span class="no">Open3</span><span class="p">.</span><span class="nf">capture2</span><span class="p">(</span><span class="s1">'bundler --version'</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"Ruby VERSION: </span><span class="si">#{</span><span class="n">ruby_version</span><span class="si">}</span><span class="s2">"</span>
    <span class="nb">puts</span> <span class="s2">"Bundler VERSION: </span><span class="si">#{</span><span class="n">bundler_version</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Now we can write a simple rake integration spec:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="code"><pre><span class="nb">require</span> <span class="s1">'rake'</span>

<span class="n">describe</span> <span class="s1">':display_versions'</span> <span class="k">do</span>
  <span class="n">let</span><span class="p">(</span><span class="ss">:version_displayer</span><span class="p">)</span> <span class="p">{</span> <span class="n">instance_double</span><span class="p">(</span><span class="s1">'VersionDisplayer'</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="nb">load</span> <span class="no">File</span><span class="p">.</span><span class="nf">expand_path</span><span class="p">(</span><span class="s1">'Rakefile'</span><span class="p">)</span>
    <span class="n">allow</span><span class="p">(</span><span class="no">VersionDisplayer</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:new</span><span class="p">).</span><span class="nf">and_return</span><span class="p">(</span><span class="n">version_displayer</span><span class="p">)</span>
    <span class="n">allow</span><span class="p">(</span><span class="n">version_displayer</span><span class="p">).</span><span class="nf">to</span> <span class="n">receive</span><span class="p">(</span><span class="ss">:display</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span><span class="n">no_args</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s1">'uses version displayer to output the version information'</span> <span class="k">do</span> 
    <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="p">[</span><span class="s1">'display_versions'</span><span class="p">].</span><span class="nf">invoke</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">version_displayer</span><span class="p">).</span><span class="nf">to</span> <span class="n">have_received</span><span class="p">(</span><span class="ss">:display</span><span class="p">).</span><span class="nf">with</span><span class="p">(</span><span class="n">no_args</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>And finally we a simple rake task that delegates all everything:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="code"><pre><span class="nb">require_relative</span> <span class="s1">'version_displayer'</span>

<span class="n">desc</span> <span class="s1">'Displays versions of bundler and ruby'</span>
<span class="n">task</span> <span class="ss">:display_versions</span> <span class="k">do</span>
  <span class="no">VersionDisplayer</span><span class="p">.</span><span class="nf">new</span><span class="p">.</span><span class="nf">display</span>
<span class="k">end</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>I much prefer this to embedding the logic in the rake task and writing
complex tests around the rake context.</p>

  </div>
</article>


  

<article class="entry">
  <header class="entry-header">
    <h3 class="entry-title">
      <a href="/2019/07/14/configuring-jenkins-properties/" rel="bookmark">Configuring Jenkins Properties As Code
</a>
    </h3>
  </header>
  <footer class="entry-meta">
    <ul>
    
      <li><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="379 72 16 16"><g><g><path fill="none" d="M380.8,86.7h12.3v-8.8h-12.3V86.7z M389.5,78.8h1.7v1.4h-1.7V78.8z M389.5,81.3h1.7v1.4h-1.7V81.3z M389.5,83.8h1.7v1.4h-1.7V83.8z M386.1,78.8h1.7v1.4h-1.7V78.8z M386.1,81.3h1.7v1.4h-1.7V81.3z M386.1,83.8h1.7v1.4h-1.7V83.8z M382.8,78.8h1.7v1.4h-1.7V78.8z M382.8,81.3h1.7v1.4h-1.7V81.3z M382.8,83.8h1.7v1.4h-1.7V83.8z"/><polygon fill="none" points="384.7 75.1 383.4 75.1 383.4 74.3 380.8 74.3 380.8 76.6 393.2 76.6 393.2 74.3 390.6 74.3 390.6 75.1 389.3 75.1 389.3 74.3 384.7 74.3"/><rect x="382.8" y="78.8" width="1.7" height="1.4"/><rect x="386.1" y="78.8" width="1.7" height="1.4"/><rect x="389.5" y="78.8" width="1.7" height="1.4"/><rect x="382.8" y="81.3" width="1.7" height="1.4"/><rect x="386.1" y="81.3" width="1.7" height="1.4"/><rect x="389.5" y="81.3" width="1.7" height="1.4"/><rect x="382.8" y="83.8" width="1.7" height="1.4"/><rect x="386.1" y="83.8" width="1.7" height="1.4"/><rect x="389.5" y="83.8" width="1.7" height="1.4"/><path d="M383.4,72v1.1h-3.8V88h14.9V73.1h-3.8V72h-1.3v1.1h-4.7V72H383.4z M393.2,86.7h-12.3v-8.8h12.3L393.2,86.7L393.2,86.7z M389.3,74.3v0.8h1.3v-0.8h2.5v2.3h-12.3v-2.3h2.5v0.8h1.3v-0.8H389.3z"/></g></g></svg></span><time class="entry-time" datetime="2019-07-14T00:00:00+00:00">July 14, 2019</time></li>
    
    
    </ul>
  </footer>
  <div class="entry-excerpt">
      <p>Jenkins appears to be the single most popular CI/CD tool despite its age and corresponding legacy tradeoffs.
When I landed on the State of <a href="https://cwds.ca.gov">California’s Child Welfare project</a> Jenkins was already the default option.
I brushed up on the new features since I had largely missed out on the new pipeline features with an actual
code as configuration option that was added to Jenkins around 2016.</p>

<p>We moved to the state’s infrastructure and Jenkins server by making heavy use of Jenkinsfiles and a few triggering
plugins like <a href="https://wiki.jenkins.io/display/JENKINS/GitHub+pull+request+builder+plugin">Github Pull Request Builder</a>
and the <a href="https://wiki.jenkins.io/display/JENKINS/Generic+Webhook+Trigger+Plugin">Generic Webhook Trigger</a>.  Later in the project, I volunteered to lead the
pipeline team to ‘Automate All the Things’. Eventually, we experimented with writing Jenkins Shared Libraries which is a
somewhat clunky way to share code between Jenkinsfiles without breaking down and writing whole Jenkins plugins.
After some early successes, we eventually moved to write a significant library of shared steps which were then used
on dozens of the organization’s projects.</p>

<p>After a time it occurred to me that we could embed many of the settings in the projects that were a pain to set up in the GUI from
within a shared library custom step.  One of the most elaborate plugins to configure was Github PullRequestBuilder, but we were
eventually able to capture all of its settings in a fairly simple step.</p>

<figure class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="n">node</span><span class="o">(</span><span class="s1">'buildNode'</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">triggerProperties</span> <span class="o">=</span> <span class="n">githubPullRequestBuilderTriggerProperties</span><span class="o">()</span>
  <span class="n">properties</span><span class="o">([</span>
    <span class="n">pipelineTriggers</span><span class="o">([</span><span class="n">triggerProperties</span><span class="o">])</span>
  <span class="o">])</span>
  <span class="o">...</span>
<span class="o">}</span></code></pre></figure>

<p>Under the covers it sets up an Frankenstien sort of object:</p>

<figure class="highlight"><pre><code class="language-groovy" data-lang="groovy"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="code"><pre><span class="o">[</span><span class="n">$class</span><span class="o">:</span> <span class="s1">'org.jenkinsci.plugins.ghprb.GhprbTrigger'</span><span class="o">,</span>
  <span class="nl">spec:</span> <span class="s1">'H/5 * * * *'</span><span class="o">,</span>
  <span class="nl">configVersion:</span> <span class="mi">3</span><span class="o">,</span>
  <span class="nl">allowMembersOfWhitelistedOrgsAsAdmin:</span> <span class="kc">true</span><span class="o">,</span>
  <span class="nl">orgslist:</span> <span class="s1">'ca-cwds'</span><span class="o">,</span>
  <span class="nl">cron:</span> <span class="s1">'H/5 * * * *'</span><span class="o">,</span>
  <span class="nl">onlyTriggerPhrase:</span> <span class="kc">false</span><span class="o">,</span>
  <span class="nl">useGitHubHooks:</span> <span class="kc">true</span><span class="o">,</span>
  <span class="nl">permitAll:</span> <span class="kc">false</span><span class="o">,</span>
  <span class="nl">autoCloseFailedPullRequests:</span> <span class="kc">false</span><span class="o">,</span>
  <span class="nl">displayBuildErrorsOnDownstreamBuilds:</span> <span class="kc">false</span><span class="o">,</span>
  <span class="nl">triggerPhrase:</span> <span class="s1">'retest this please'</span><span class="o">,</span>
  <span class="nl">skipBuildPhrase:</span> <span class="s1">'.*\\[skip\\W+ci\\].*'</span><span class="o">,</span>
  <span class="nl">extensions:</span> <span class="o">[</span>
                <span class="o">[</span>
                    <span class="n">$class</span><span class="o">:</span> <span class="s1">'org.jenkinsci.plugins.ghprb.extensions.build.GhprbCancelBuildsOnUpdate'</span><span class="o">,</span>
                    <span class="nl">overrideGlobal:</span> <span class="kc">false</span>
                <span class="o">],</span>
                <span class="o">[</span>
                    <span class="n">$class</span><span class="o">:</span> <span class="s1">'org.jenkinsci.plugins.ghprb.extensions.status.GhprbSimpleStatus'</span><span class="o">,</span>
                    <span class="nl">commitStatusContext:</span> <span class="s1">'Pull Request Testing'</span><span class="o">,</span>
                    <span class="nl">statusUrl:</span> <span class="s1">'https://jenkins.example.com'</span><span class="o">,</span>
                    <span class="nl">addTestResults:</span> <span class="kc">false</span><span class="o">,</span>
                    <span class="nl">completedStatus:</span> <span class="o">[</span>
                      <span class="o">[</span>
                        <span class="n">$class</span><span class="o">:</span> <span class="s1">'org.jenkinsci.plugins.ghprb.extensions.comments.GhprbBuildResultMessage'</span><span class="o">,</span>
                        <span class="nl">message:</span> <span class="s1">'Success'</span><span class="o">,</span>
                        <span class="nl">result:</span> <span class="s1">'SUCCESS'</span>
                      <span class="o">],</span>
                      <span class="o">[</span>
                        <span class="n">$class</span><span class="o">:</span> <span class="s1">'org.jenkinsci.plugins.ghprb.extensions.comments.GhprbBuildResultMessage'</span><span class="o">,</span>
                        <span class="nl">message:</span> <span class="s1">'Build Failed'</span><span class="o">,</span>
                        <span class="nl">result:</span> <span class="s1">'FAILURE'</span>
                      <span class="o">],</span>
                      <span class="o">[</span>
                        <span class="n">$class</span><span class="o">:</span> <span class="s1">'org.jenkinsci.plugins.ghprb.extensions.comments.GhprbBuildResultMessage'</span><span class="o">,</span>
                        <span class="nl">message:</span> <span class="s1">'Build Error'</span><span class="o">,</span>
                        <span class="nl">result:</span> <span class="s1">'ERROR'</span>
                      <span class="o">]</span>
                    <span class="o">]</span>
                  <span class="o">]</span>
              <span class="o">]</span>
    <span class="o">]</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>This saved significant time for any team trying to set up their first pull-request based build in their Jenkinsfile, as
they no longer had to figure out all of the boxes to check and text fields to fill out.  So if you’re just getting started
trying to reuse code among Jenkinfiles don’t forget the option of embedding complex config as well.</p>

<p>Notes:</p>

<p>We’ve pulled in three things now Jenkins Github plugin, GHPRB, Generic Webhook Trigger.
Had to deal with them as steps.
Eventual goal is to move all config out of Jenkins into code.
Unfortunate bootstrap issue especially with triggers, or a first time project.
Jenkins X is supposed to provide some of this functionality.</p>

  </div>
</article>


  

<article class="entry">
  <header class="entry-header">
    <h3 class="entry-title">
      <a href="/2019/01/13/concourse-ci-eval/" rel="bookmark">Evaluating Concourse CI
</a>
    </h3>
  </header>
  <footer class="entry-meta">
    <ul>
    
      <li><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="379 72 16 16"><g><g><path fill="none" d="M380.8,86.7h12.3v-8.8h-12.3V86.7z M389.5,78.8h1.7v1.4h-1.7V78.8z M389.5,81.3h1.7v1.4h-1.7V81.3z M389.5,83.8h1.7v1.4h-1.7V83.8z M386.1,78.8h1.7v1.4h-1.7V78.8z M386.1,81.3h1.7v1.4h-1.7V81.3z M386.1,83.8h1.7v1.4h-1.7V83.8z M382.8,78.8h1.7v1.4h-1.7V78.8z M382.8,81.3h1.7v1.4h-1.7V81.3z M382.8,83.8h1.7v1.4h-1.7V83.8z"/><polygon fill="none" points="384.7 75.1 383.4 75.1 383.4 74.3 380.8 74.3 380.8 76.6 393.2 76.6 393.2 74.3 390.6 74.3 390.6 75.1 389.3 75.1 389.3 74.3 384.7 74.3"/><rect x="382.8" y="78.8" width="1.7" height="1.4"/><rect x="386.1" y="78.8" width="1.7" height="1.4"/><rect x="389.5" y="78.8" width="1.7" height="1.4"/><rect x="382.8" y="81.3" width="1.7" height="1.4"/><rect x="386.1" y="81.3" width="1.7" height="1.4"/><rect x="389.5" y="81.3" width="1.7" height="1.4"/><rect x="382.8" y="83.8" width="1.7" height="1.4"/><rect x="386.1" y="83.8" width="1.7" height="1.4"/><rect x="389.5" y="83.8" width="1.7" height="1.4"/><path d="M383.4,72v1.1h-3.8V88h14.9V73.1h-3.8V72h-1.3v1.1h-4.7V72H383.4z M393.2,86.7h-12.3v-8.8h12.3L393.2,86.7L393.2,86.7z M389.3,74.3v0.8h1.3v-0.8h2.5v2.3h-12.3v-2.3h2.5v0.8h1.3v-0.8H389.3z"/></g></g></svg></span><time class="entry-time" datetime="2019-01-13T00:00:00+00:00">January 13, 2019</time></li>
    
    
    </ul>
  </footer>
  <div class="entry-excerpt">
      <p>Over the holidays I had a chance to do a review of the CI options out there. I’m more than happy with something like Travis, and
I’ve often said Jenkins is the Wordpress of CI Servers even though I’ve used it now for the bulk of my career.  Currently, I’m working
on building out a full production pipeline for the State of California where we are attempting to be transparent and use AGPL 3.0 for all of
our code.  That pretty much eliminated Travis CI, Codeship, and Circle CI.  I realize they’re free for open source projects in general, but
suffice it to say that getting a SASS solution, even a free one approved with some level of access to our Github organization is a tall order
with the existing policies in place.  So self-hosted open source was going to be our options.</p>

<p>So one of our options was <a href="https://concourse-ci.org">Concourse CI</a>, so I sat down with several hours to dive in and take a good look at it.</p>

<p>There is a lengthy <a href="https://concoursetutorial.com">tutorial</a> put out by some developers from <a href="https://starkandwayne.com">Stark and Wayne</a>. The
tutorial gives you a good sense of how it would be to use Concourse CI. I did find a few stumbling blocks running through it:</p>

<h3 id="fly-install">Fly Install</h3>
<p><a href="https://concoursetutorial.com">Introduction</a></p>

<p>There isn’t a convenient brew install, so I had to go looking for this command to install instead. (You can download from the initial docker container,
but it downloaded a strange fly.dms file for me, and I found it easier to download and install directly.)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="nt">-Lo</span> fly https://github.com/concourse/concourse/releases/download/v4.2.2/fly_darwin_amd64 <span class="o">&amp;&amp;</span> <span class="nb">chmod</span> +x fly <span class="o">&amp;&amp;</span> <span class="nb">mv </span>fly /usr/local/bin/
</code></pre></div></div>
<h3 id="private-keys">Private Keys</h3>
<p><a href="https://concoursetutorial.com/basics/publishing-outputs/">Publishing Outputs</a></p>

<p>The tutorial step where you publish outputs involves putting private keys in your pipeline.yml file which feels terrible. I was able to swap
it out to use a personal access token on GitHub by switching the out the :uri under the git resource for username and password where password is
just the reference to the personal access token. I was surprised to see the use of private keys at all in the tutorial. I also made sure
to lock down the token to only be able to create gists since this tutorial step updates a particular gist.</p>

<p><em>Original Config</em></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">resource-gist</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
  <span class="na">source</span><span class="pi">:</span>
    <span class="na">uri</span><span class="pi">:</span> <span class="s">git@gist.github.com:e028e491e42b9fb08447a3bafcf884e5.git</span>
    <span class="na">branch</span><span class="pi">:</span> <span class="s">master</span>
    <span class="na">private_key</span><span class="pi">:</span> <span class="pi">|-</span>
      <span class="s">-----BEGIN RSA PRIVATE KEY-----</span>
      <span class="s">MIIEpQIBAAKCAQEAuvUl9YU...</span>
      <span class="s">...</span>
      <span class="s">HBstYQubAQy4oAEHu8osRhH...</span>
      <span class="s">-----END RSA PRIVATE KEY-----</span>
</code></pre></div></div>

<p><em>Config With Personal Access Token</em></p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">resource-gist</span>
  <span class="na">type</span><span class="pi">:</span> <span class="s">git</span>
  <span class="na">source</span><span class="pi">:</span>
    <span class="na">uri</span><span class="pi">:</span> <span class="s">https://gist.github.com/e028e491e42b9fb08447a3bafcf884e5.git</span>
    <span class="na">branch</span><span class="pi">:</span> <span class="s">master</span>
    <span class="na">username</span><span class="pi">:</span> <span class="s">edgibbs</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s">ddf78dffcaf4398bec2323</span>
</code></pre></div></div>

<h3 id="credhub">CredHub</h3>
<p><a href="https://concoursetutorial.com/basics/secret-parameters/">Secrets With Credentials Manager</a></p>

<p>After the step of making sure I had an up to date VirtualBox and cloning Stark and Wayne’s CLI <code class="language-plaintext highlighter-rouge">bucc</code>, it
failed right away. They have a note about needing <code class="language-plaintext highlighter-rouge">direnv</code>, but I had to do a bit more config with it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'eval "$(./bin/bucc env)"'</span> <span class="o">&gt;</span> .envrc
brew <span class="nb">install </span>direnv
direnv allow
</code></pre></div></div>

<p>Despite these few missteps I was able to work my way through the tutorial and get an overall impression.</p>

<h1 id="takeaways">Takeaways</h1>

<h2 id="overall-architecture">Overall Architecture</h2>

<p>Under the covers Concourse relies on three main parts:</p>

<ul>
  <li>A master server, the ATC or air traffic controller that is the heart of concourse</li>
  <li>The TSA which is an ssh server for registering workers with the ATC</li>
  <li>Postgres for storing persistent data</li>
</ul>

<p>A pipeline in Concourse also has three main items:</p>

<ul>
  <li>Resources are things like git, artifact creation, or Slack</li>
  <li>Resource types are custom resources that you can define or use other community contributed resources</li>
  <li>Jobs are where the work of the pipeline happens</li>
</ul>

<p>In contrast with Jenkins, there is a UI with the TSA, but it is used only for reporting or potentially
kicking off jobs.  The main interface is the <code class="language-plaintext highlighter-rouge">fly</code> CLI. And everything essentially runs inside containers like
Docker.</p>

<h2 id="impressions">Impressions</h2>

<p>Much of the workflow derives from the CLI, and pipelines are first class citizens. The ability to test
out a pipeline locally with <code class="language-plaintext highlighter-rouge">fly</code> is way ahead of setting up something like Jenkins especially if your organization
uses a lot of plugins. Another change is because Concourse is designed to have atomic jobs so you can actually retrigger
a pipeline from a particular stage.</p>

<p>The UI in Concourse is a minimalist dark mode style web interface. Jenkins still feels like it’s straight out of 2002, so
it was nice to see a visual representation with boxes and lines versus the tables of Jenkins current pipeline representations.</p>

<p>One area that looks like it might be a pain with Concourse is its support for artifacts. Since each job is atomic, you have to
handle passing things between jobs by pushing it out and storing it with a resource. Then some late job can pick it up
and process it further.</p>

<p>The declarative style syntax of the pipelines appears to be fine, though I wouldn’t have minded the option to escape out to a full
programming language.</p>

<p>Overall I thought it was an novel direction on CI servers and worth a deeper dive down the road.</p>

  </div>
</article>


  

<article class="entry">
  <header class="entry-header">
    <h3 class="entry-title">
      <a href="/2016/02/08/the-dark-side-of-javascript-fatigue/" rel="bookmark">The Dark Side of Javascript Fatigue
</a>
    </h3>
  </header>
  <footer class="entry-meta">
    <ul>
    
      <li><span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="379 72 16 16"><g><g><path fill="none" d="M380.8,86.7h12.3v-8.8h-12.3V86.7z M389.5,78.8h1.7v1.4h-1.7V78.8z M389.5,81.3h1.7v1.4h-1.7V81.3z M389.5,83.8h1.7v1.4h-1.7V83.8z M386.1,78.8h1.7v1.4h-1.7V78.8z M386.1,81.3h1.7v1.4h-1.7V81.3z M386.1,83.8h1.7v1.4h-1.7V83.8z M382.8,78.8h1.7v1.4h-1.7V78.8z M382.8,81.3h1.7v1.4h-1.7V81.3z M382.8,83.8h1.7v1.4h-1.7V83.8z"/><polygon fill="none" points="384.7 75.1 383.4 75.1 383.4 74.3 380.8 74.3 380.8 76.6 393.2 76.6 393.2 74.3 390.6 74.3 390.6 75.1 389.3 75.1 389.3 74.3 384.7 74.3"/><rect x="382.8" y="78.8" width="1.7" height="1.4"/><rect x="386.1" y="78.8" width="1.7" height="1.4"/><rect x="389.5" y="78.8" width="1.7" height="1.4"/><rect x="382.8" y="81.3" width="1.7" height="1.4"/><rect x="386.1" y="81.3" width="1.7" height="1.4"/><rect x="389.5" y="81.3" width="1.7" height="1.4"/><rect x="382.8" y="83.8" width="1.7" height="1.4"/><rect x="386.1" y="83.8" width="1.7" height="1.4"/><rect x="389.5" y="83.8" width="1.7" height="1.4"/><path d="M383.4,72v1.1h-3.8V88h14.9V73.1h-3.8V72h-1.3v1.1h-4.7V72H383.4z M393.2,86.7h-12.3v-8.8h12.3L393.2,86.7L393.2,86.7z M389.3,74.3v0.8h1.3v-0.8h2.5v2.3h-12.3v-2.3h2.5v0.8h1.3v-0.8H389.3z"/></g></g></svg></span><time class="entry-time" datetime="2016-02-08T20:54:20+00:00">February 8, 2016</time></li>
    
    
    </ul>
  </footer>
  <div class="entry-excerpt">
      <p>Javascript fatigue is a real experience for many developers who don’t spend their day to day in Node.js bashing out javascript. For many developers javascript is an occasional concern. The thing I can’t figure out about the javascript development world is the incredible churn. Churn is often disaster for a programming community. It frustrates anyone trying to build a solid application that will have a shelf life of a decade or more. Newcomers are treated to overwhelming choices without enough knowledge to choose. Then they find what they’ve learned is no longer the new and shiny tool only a few months later. And anyone on the outside feels validated in not jumping in.</p>

<p>Many in the javascript community attempt to couch all the churn as a benefit. It’s the incredible pace of innovation. I see sentiments like this:</p>

<blockquote>
  <p>The truth is, if you don’t like to constantly be learning new things, web development is probably not for you. You might have chosen the wrong career!</p>
</blockquote>

<blockquote>
  <p>— <a href="https://medium.com/@joshburgess/javascript-fatigue-an-alternative-perspective-b6ae411e89ac#.io6cl65k9">Josh Burgess</a></p>
</blockquote>

<p>Even if we accept that it all the ‘innovation’ is moving things forward more quickly, there is rarely the reflection on the consequences. I’ve worked on an approximately 9 year old Rails app for about 5 years now and I’m still shocked by the number different frameworks and styles of javascript that litter the app:</p>

<ul>
  <li>Hand rolled pre JQuery javascript</li>
  <li>Javascript cut and paste style</li>
  <li>RJS (an attempt to avoid writing javascript altogether in early rails)</li>
  <li>YUI</li>
  <li>Prototype</li>
  <li>Google Closure</li>
  <li>JQuery</li>
  <li>Angular</li>
</ul>

<p>Eight different frameworks in about as many years. And though we adopted Angular about 2 years ago we’re already dealing with non-backwards compatibility, Angular 2.0. This is a large burden on maintenance and it costs us very real time to spin up on each one when we have to enhance the app or fix a bug.</p>

<p>This is a monolithic app that’s been built over quite a few years, but the big difference is the Rails app was opinionated and stuck to a lot of default conventions. The framework churn of Rails has been much more gradual and generally backwards compatible. The largest pain we experience was going from Rails 2 to 3, when Rails was merged with Merb. The knowledge someone built up in their first few years working in Ruby and Rails still applies. The churn is certainly exists, but at a measure pace.</p>

<p>In phone screens when I describe our main app, I list off the myriad javascript frameworks we use as a negative they should know about. And almost none of the candidates have heard of Google Closure, even though a critical piece of the app was written in it. They often assume I must be talking about the JVM Clojure.</p>

<p>Javascript has never been popular because of elegance or syntax. Rants like the following are not hard to find:</p>

<blockquote>
  <p>You see the Node.js philosophy is to take the worst fucking language ever designed and put it on the server.</p>
</blockquote>

<blockquote>
  <p>— <a href="https://medium.com/@wob/the-sad-state-of-web-development-1603a861d29f#.2v49dasi5">Drew Hamlett</a></p>
</blockquote>

<p>Large majorities of developers would rather avoid it completely to focus on any modern language and hopefully use a transpiler if they have to touch Javascript. In this environment it might do the javascript community some good to settle down some and focus on some stability.</p>

  </div>
</article>



<!-- Pagination links -->
<nav class="pager">
  <ul>
    <!-- Page: 2 of 152 -->
    
      <li><a href="/" class="previous"><span class="icon icon--arrow-right"><svg xmlns="http://www.w3.org/2000/svg" viewBox="430 -22.8 16 16"><path d="M433.4-15.7c-.2.2-.4.5-.4.9 0 .3.1.6.4.9l6.7 6.7c.2.3.5.4.9.4.3 0 .6-.1.9-.4l.8-.8c.3-.2.4-.5.4-.9 0-.3-.1-.6-.4-.9l-5-5 5-5c.3-.2.4-.5.4-.9 0-.3-.1-.6-.4-.9l-.8-.8c-.2-.3-.5-.4-.9-.4-.3 0-.7.1-.9.4l-6.7 6.7z"/></svg></span> Newer</a></li>
    
    
      <li><a href="/page3/" class="next">Older <span class="icon icon--arrow-right"><svg xmlns="http://www.w3.org/2000/svg" viewBox="50.4 -114.8 16 16"><path d="M63.1-107.7l-6.7-6.7c-.2-.3-.6-.4-.9-.4-.4 0-.7.1-.9.4l-.8.8c-.3.3-.4.6-.4.9 0 .4.1.7.4.9l5 5-5 5c-.3.3-.4.6-.4.9 0 .4.1.7.4.9l.8.8c.3.3.6.4.9.4.4 0 .7-.1.9-.4l6.7-6.7c.3-.3.4-.6.4-.9 0-.4-.2-.7-.4-.9z"/></svg></span></a></li>
    
  </ul>
</nav>
        
      </div>
    </div>

    <footer id="footer" class="site-footer">
  <div class="inner">
    <div class="copyright">
      
        <p>&copy; 2025 Musings of a Software Development Manager.</p>
      
    </div>
  </div>
</footer>

  </div>
</main>

        </div>

        <div class="search-content">
          <div class="inner">
  
</div>

        </div>
      </div>
    </div>

    

<script async src="/assets/javascripts/main.js"></script>




  </body>

</html>
